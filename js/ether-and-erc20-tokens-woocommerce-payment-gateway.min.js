function epg_round(a,b,c){var d,e,f,g;if(b|=0,d=Math.pow(10,b),a*=d,g=a>0|-(a<0),f=a%1==.5*g,e=Math.floor(a),f)switch(c){case"PHP_ROUND_HALF_DOWN":a=e+(g<0);break;case"PHP_ROUND_HALF_EVEN":a=e+e%2*g;break;case"PHP_ROUND_HALF_ODD":a=e+!(e%2);break;default:a=e+(g>0)}return(f?a:Math.round(a))/d}function epg_tokenChange(a){if(a.preventDefault(),window.epg.is_wizard_initialised){"ETH"!==jQuery("#epg-token").val()&&jQuery("#rootwizard").bootstrapWizard("show",EPG_STEP.deposit)}setTimeout(function(){epg_fill_payment_info(function(a,b){if(a)return void epg_alert(a)})},1)}function epg_fill_payment_info(a){void 0===a&&(a=function(){});var b=jQuery("#epg-token").val();"ETH"===b?epg_fill_ether_payment_info(function(b,c){void 0!==window.epg["epg-ether-advanced-details-opened"]||"undefined"!=typeof window&&void 0!==window.web3||(jQuery("#epg-ether-advanced-details-button").click(),jQuery("#epg-ether-advanced-details-button").parent().hide(),window.epg["epg-ether-advanced-details-opened"]=!0),a.call(null,b,c)}):epg_fill_token_payment_info(b,function(b,c){void 0!==window.epg["epg-token-advanced-details-step1-opened"]||"undefined"!=typeof window&&void 0!==window.web3||(jQuery("#epg-token-advanced-details-step1-button").click(),jQuery("#epg-token-advanced-details-step1-button").parent().hide(),window.epg["epg-token-advanced-details-step1-opened"]=!0),change_epg_gateway_address(),change_epg_data_value(),a.call(null,b,c)})}function epg_alert(a){var b=setTimeout(function(){clearTimeout(b),alert(a)},1)}function epg_getTokenInfoBySymbol(a){if(""===window.epg.tokens_supported)return null;for(var b=window.epg.tokens_supported.split(","),c=0;c<b.length;c++){var d=b[c],e=d.split(":");if(3===e.length){var f=e[0],g=e[1],h=e[2];if(f.toLowerCase()===a.toLowerCase())return{symbol:f,address:g,rate:h}}}return null}function epg_getTokenInfoByAddress(a){if(""===window.epg.tokens_supported)return null;for(var b=window.epg.tokens_supported.split(","),c=0;c<b.length;c++){var d=b[c],e=d.split(":");if(3===e.length){var f=e[0],g=e[1],h=e[2];if(g.toLowerCase()===a.toLowerCase())return{symbol:f,address:g,rate:h}}}return null}function epg_fill_token_payment_info(a,b){void 0===b&&(b=function(){}),epg_initWizard(function(c,d){if(c)return void b.call(null,c,d);jQuery("#epg-ether-payment").addClass("hidden"),jQuery("#epg-ether-payment").attr("hidden"," hidden"),jQuery("#epg-data-value-group").removeClass("hidden"),jQuery("#epg-data-value-group").removeAttr("hidden"),jQuery("#epg-balance-group").addClass("hidden"),jQuery("#epg-balance-group").attr("hidden"," hidden");var e=epg_getTokenInfoBySymbol(a);if(e){jQuery("#epg-gateway-address").val(e.address);if(null===epg_getTokenRate(e.address))return console.log("Failed to get token rate"),jQuery("#epg-amount").val(""),jQuery("#epg-amount2").val(""),void b.call(null,"Failed to get token rate",null);epg_get_token_decimals(e.address,function(a,c){if(a)return console.log(a),jQuery("#epg-amount").val(""),jQuery("#epg-amount2").val(""),void b.call(null,a,null);if(null===c)return console.log("Failed to obtain ERC20 token decimals value"),jQuery("#epg-amount").val(""),jQuery("#epg-amount2").val(""),void b.call(null,"Failed to obtain ERC20 token decimals value",null);var d=epg_getTokenRate(e.address);if(null===d)return console.log("Failed to obtain token rate"),jQuery("#epg-amount").val(""),jQuery("#epg-amount2").val(""),void b.call(null,"Failed to obtain token rate",null);var f=parseFloat(window.epg.eth_value)/d,g=Math.ceil(f*Math.pow(10,c.toNumber()));f=g/Math.pow(10,c.toNumber()),jQuery("#epg-amount").val(f),jQuery("#epg-amount2").val(f),jQuery("#epg-value").val(0),epg_token_approve_getData(e.address,f,function(a,c){if(a)return console.log(a),jQuery("#epg-data-value").text(""),void b.call(null,a,null);jQuery("#epg-data-value").text(c),epg_token_check_deposit(e.address,f,function(a,c){if(a)return console.log(a),epg_alert(a),void b.call(null,a,null);if(!0===c){jQuery("#rootwizard").bootstrapWizard("show",EPG_STEP.payment);var d=setTimeout(function(){clearTimeout(d),jQuery("#epg-button-next").removeClass("disabled")},1);jQuery("#epg-payment-deposit-made-message-wrapper").removeClass("hidden"),jQuery("#epg-payment-deposit-made-message-wrapper").removeAttr("hidden"),jQuery("#epg-payment-incomplete-message-wrapper").addClass("hidden"),jQuery("#epg-payment-incomplete-message-wrapper").attr("hidden"," hidden"),jQuery("#epg-payment-success-message-wrapper").addClass("hidden"),jQuery("#epg-payment-success-message-wrapper").attr("hidden"," hidden"),jQuery("#epg-ether-payment").addClass("hidden"),jQuery("#epg-ether-payment").attr("hidden"," hidden")}else jQuery("#epg-payment-deposit-made-message-wrapper").addClass("hidden"),jQuery("#epg-payment-deposit-made-message-wrapper").attr("hidden","hidden"),jQuery("#epg-payment-incomplete-message-wrapper").removeClass("hidden"),jQuery("#epg-payment-incomplete-message-wrapper").removeAttr("hidden"," hidden");b.call(null,null,null)})})})}else console.log("failed to find token info"),jQuery("#epg-data-value").text(""),jQuery("#epg-amount").val(""),jQuery("#epg-amount2").val(""),jQuery("#epg-value").val(""),b.call(null,"failed to find token info",null)})}function epg_fill_ether_payment_info(a){void 0===a&&(a=function(){}),jQuery("#epg-ether-payment").removeClass("hidden"),jQuery("#epg-ether-payment").removeAttr("hidden"),jQuery("#epg-payment-deposit-made-message-wrapper").addClass("hidden"),jQuery("#epg-payment-deposit-made-message-wrapper").attr("hidden","hidden"),jQuery("#epg-payment-incomplete-message-wrapper").removeClass("hidden"),jQuery("#epg-payment-incomplete-message-wrapper").removeAttr("hidden"," hidden"),jQuery("#rootwizard").addClass("hidden"),jQuery("#rootwizard").attr("hidden"," hidden"),jQuery("#rootwizard-help-info").addClass("hidden"),jQuery("#rootwizard-help-info").attr("hidden"," hidden"),a.call(null,null,null)}function epg_get_step_number(){return"ETH"===jQuery("#epg-token").val()?null:jQuery("#epg-payment-step1").hasClass("active")?EPG_STEP.deposit:jQuery("#epg-payment-step2").hasClass("active")?EPG_STEP.payment:(console.log("EPG INTERNAL ERROR: unknown step!"),null)}function epg_switch_to_step2(a){jQuery("#epg-button-next").text(window.epg.str_pay_button_text),jQuery("#epg-gateway-address").val(window.epg.gateway_address),jQuery("#epg-gateway-address-step2").val(window.epg.gateway_address);var b=jQuery("#epg-token").val();if("ETH"===b)epg_payEth_getData(function(b,c){if(b)return console.log(b),jQuery("#epg-data-value-step2").text(""),void a.call(null,b,null);jQuery("#epg-data-value-step2").text(c),a.call(null,null,c)});else{var c=epg_getTokenInfoBySymbol(b);c?epg_payToken_getData(c.address,function(b,c){if(b)return console.log(b),jQuery("#epg-data-value-step2").text(""),void a.call(null,b,null);jQuery("#epg-data-value-step2").text(c),a.call(null,null,c)}):(console.log("Failed to obtain token info"),a.call(null,window.epg.str_pay_token_failure,null))}}function epg_switch_to_step1(a){epg_fill_payment_info(function(b,c){if(b)return void a.call(null,b,c);jQuery("#epg-button-next").text(window.epg.str_make_deposit_button_text),a.call(null,b,c)})}function epg_getUserAccounts(a){var b=function(a){a.call(null,window.epg.str_download_metamask,[])},c=null;void 0!==window.epg.web3metamask&&(b=window.epg.web3metamask.eth.getAccounts,c=window.epg.web3metamask.eth),b.call(c,function(b,c){a.call(null,b,c)})}function epg_awaitBlockConsensus(a,b,c,d){var e,f,g=window.epg.web3,h=Number.MAX_SAFE_INTEGER,i={start:1,mined:2,awaited:3,confirmed:4,unconfirmed:5},j=0,k=i.start,l=function(){if(k===i.start)g.eth.getTransaction(a,function(a,b){a||null===b||null!==b.blockHash&&(h=b.blockNumber,f=b,console.log("mined"),k=i.mined)});else if(k===i.mined)g.eth.getBlockNumber(function(a,c){a||(console.log("blockNum: ",c),c>=b+h&&(k=i.awaited))});else{if(k!==i.awaited)return void d(new Error("We should never get here, illegal state: "+k),null);g.eth.getTransactionReceipt(a,function(a,b){a||null===b||(clearInterval(e),b.gasUsed>=f.gas?(k=i.unconfirmed,d(new Error("we ran out of gas, not confirmed!"),null)):(k=i.confirmed,d(null,b)))})}++j>c&&(clearInterval(e),k=i.unconfirmed,d(new Error("Timed out, not confirmed"),null))};e=setInterval(l,1e3),l()}function epg_sendTransaction_aux(a,b,c,d){if(window.epg.mm_network_mismatch)return void d.call(null,window.epg.str_metamask_network_mismatch,null);epg_getUserAccounts(function(e,f){if(e)return console.log(e),void d.call(null,e,null);if(0===f.length)return console.log("Metamask account not found"),void d.call(null,window.epg.str_unlock_metamask_account,null);var g=f[0],h={from:g,to:a,value:b,gas:window.epg.gas_limit,gasPrice:1e9*parseFloat(window.epg.gas_price),data:c,nonce:"0x00"};epg_show_wait_icon(),window.epg.web3.eth.getTransactionCount(g,function(a,b){if(a)return epg_hide_wait_icon(),console.log(a),console.log("Network error. Check your infuraApiKey settings."),void d.call(null,a,null);console.log("Current address nonce value: ",b);var c=parseInt(b);h.nonce="0x"+c.toString(16),console.log(h),window.epg.web3metamask.eth.sendTransaction(h,function(a,b){if(a)return epg_hide_wait_icon(),console.log(a),void d.call(null,a,null);console.log(b),epg_awaitBlockConsensus(b,12,300,function(a,c){if(epg_hide_wait_icon(),a)return console.log(a),void d.call(null,a,b);d.call(null,null,b)})})})})}function epg_sendTransaction_aux2(a,b,c){var d=jQuery("#epg-token").val(),e=jQuery("#epg-gateway-address").val();"ETH"===d&&(e=jQuery("#epg-ether-gateway-address").val()),epg_sendTransaction_aux(e,a,b,function(a,b){if(a)return console.log(a),a===window.epg.str_unlock_metamask_account?void c.call(null,a,null):void("ETH"===d?c.call(null,window.epg.str_pay_eth_failure,null):c.call(null,window.epg.str_pay_token_failure,null));console.log("tx: ",b),c.call(null,null,b)})}function epg_sendTransaction_impl(a){var b=jQuery("#epg-token").val();if("ETH"===b){epg_sendTransaction_aux2(window.epg.eth_value_with_dust,window.epg.payment_address,a)}else{var c=parseFloat(jQuery("#epg-amount").val());epg_get_token_balance(b,function(b,d){return b?(console.log(b),void a.call(null,b,null)):d<c?void a.call(null,window.epg.str_pay_token_failure_insufficient_balance,null):void epg_sendTransaction_aux2(window.epg.web3.toWei(parseFloat(jQuery("#epg-value").val()),"ether"),jQuery("#epg-data-value").text(),a)})}}function epg_get_token_balance(a,b){epg_getUserAccounts(function(c,d){if(c)return console.log(c),void b.call(null,c,null);if(0===d.length)return console.log("Metamask account not found"),void b.call(null,window.epg.str_unlock_metamask_account,null);var e=epg_getTokenInfoBySymbol(a);if(!e)return console.log("Failed to obtain token info"),void b.call(null,window.epg.str_pay_token_failure,null);epg_get_token_decimals(e.address,function(a,c){return a?(console.log(a),void b.call(null,window.epg.str_pay_token_failure,null)):null===c?(console.log("Failed to obtain ERC20 token decimals value"),void b.call(null,window.epg.str_pay_token_failure,null)):null===epg_getTokenRate(e.address)?(console.log("Failed to obtain token rate"),void b.call(null,window.epg.str_pay_token_failure,null)):void epg_get_token_balance_by_account(e.address,d[0],function(a,d){if(a)return console.log(a),void b.call(null,window.epg.str_pay_token_failure,null);console.log("Token balance: ",d.toNumber());var e=d.toNumber()/Math.pow(10,c.toNumber());b.call(null,null,e)})})})}function epg_sendTransaction_eth_step2_impl(){var a=jQuery("#epg-token").val(),b=jQuery("#epg-gateway-address").val();"ETH"===a&&(b=jQuery("#epg-ether-gateway-address").val()),epg_sendTransaction_aux(b,0,jQuery("#epg-data-value-step2").text(),function(b,c){if(b){if(console.log(b),b===window.epg.str_unlock_metamask_account)return;return void alert(window.epg.str_pay_token_failure)}epg_show_wait_icon(),epg_getValuePayment(function(b,c){if(b)return console.log(b),epg_alert("ETH"===a?window.epg.str_pay_eth_failure:window.epg.str_pay_token_failure),void epg_hide_wait_icon();if("ETH"===a){epg_hide_wait_icon();var d=c.toNumber()/window.epg.web3.toWei(1,"ether");if(epg_round(d,5,"PHP_ROUND_HALF_UP")<parseFloat(window.epg.eth_value))return console.log("Low value: ",d,"ETH"),void epg_alert(window.epg.str_pay_eth_failure)}else{var e=epg_getTokenInfoBySymbol(a);e?epg_get_token_decimals(e.address,function(b,d){if(epg_hide_wait_icon(),b)return console.log(b),void epg_alert(window.epg.str_pay_token_failure);if(null===d)return console.log("Failed to obtain ERC20 token decimals value"),void epg_alert(window.epg.str_pay_token_failure);var e=parseFloat(jQuery("#epg-amount").val()),f=c.toNumber()/Math.pow(10,d.toNumber());return f<e?(console.log("Low value: ",f,a),void epg_alert(window.epg.str_pay_token_failure)):void 0}):epg_hide_wait_icon()}epg_hide_wait_icon(EPG_STEP.result),setTimeout(function(){location.reload()},1)})})}function epg_show_wait_icon(){switch(jQuery("#epg-spinner").addClass("is-active"),jQuery("#epg-alert").removeClass("hidden"),jQuery("#epg-alert").removeAttr("hidden"),jQuery("#epg-ether-spinner").addClass("is-active"),jQuery("#epg-ether-alert").removeClass("hidden"),jQuery("#epg-ether-alert").removeAttr("hidden"),jQuery("#epg-token").attr("disabled","disabled"),epg_get_step_number()){case EPG_STEP.deposit:case EPG_STEP.payment:}}function epg_hide_wait_icon(a){switch(void 0===a&&(a=epg_get_step_number()),jQuery("#epg-spinner").removeClass("is-active"),jQuery("#epg-alert").addClass("hidden"),jQuery("#epg-alert").attr("hidden"," hidden"),jQuery("#epg-ether-spinner").removeClass("is-active"),jQuery("#epg-ether-alert").addClass("hidden"),jQuery("#epg-ether-alert").attr("hidden"," hidden"),jQuery("#epg-token").removeAttr("disabled"),a){case EPG_STEP.deposit:case EPG_STEP.payment:}}function epg_getBalanceEth(a){epg_getUserAccounts(function(b,c){if(b)return console.log(b),void a.call(null,b,null);if(0===c.length)return console.log("Metamask account not found"),void a.call(null,window.epg.str_unlock_metamask_account,null);var d=epg_get_gateway_contract();if(!d){console.log("Failed to obtain a gateway contract");return void("ETH"===jQuery("#epg-token").val()?a.call(null,window.epg.str_pay_eth_failure,null):a.call(null,window.epg.str_pay_token_failure,null))}d.getBalanceEth(function(b,c){if(b)return console.log(b),void a.call(null,b,null);console.log(c),a.call(null,b,c)})})}function epg_getValuePaymentEth(a){epg_getCurrencyPayment(function(b,c){return b?(console.log(b),void a.call(null,b,null)):"0x0000000000000000000000000000000000000000"===c||"0x"===c?void a.call(null,null,null):void epg_getValuePayment(function(b,d){return b?(console.log(b),void a.call(null,b,null)):"0x0000000000000000000000000000000000000001"===c?void a.call(null,null,d.toNumber()/window.epg.web3.toWei(1,"ether")):void epg_get_token_decimals(c,function(b,e){if(b)return console.log(b),void a.call(null,b,null);if(null===e)return console.log("Failed to obtain ERC20 token decimals value"),void a.call(null,window.epg.str_pay_token_failure,null);var f=epg_getTokenRate(c);if(null===f)return console.log("Failed to obtain token rate"),void a.call(null,window.epg.str_pay_token_failure,null);if(!epg_get_gateway_contract())return console.log("Failed to obtain a gateway contract"),void a.call(null,"Failed to obtain a gateway contract",null);var g=f*d.toNumber()/Math.pow(10,e.toNumber());a.call(null,null,g)})})})}function epg_getValuePayment_v1(a){var b=epg_get_gateway_contract_v1();if(!b){console.log("Failed to obtain a gateway contract");return void("ETH"===jQuery("#epg-token").val()?a.call(null,window.epg.str_pay_eth_failure,null):a.call(null,window.epg.str_pay_token_failure,null))}b.getValuePayment(window.epg.payment_address,window.epg.order_id,function(b,c){if(b)return console.log(b),void a.call(null,b,null);console.log(c),a.call(null,b,c)})}function epg_getValuePayment(a){var b=epg_get_gateway_contract();if(!b){console.log("Failed to obtain a gateway contract");return void("ETH"===jQuery("#epg-token").val()?a.call(null,window.epg.str_pay_eth_failure,null):a.call(null,window.epg.str_pay_token_failure,null))}b.getValuePayment(window.epg.payment_address,window.epg.order_id,function(b,c){return b?(console.log(b),void a.call(null,b,null)):(console.log(c),0===c.toNumber()?void epg_getValuePayment_v1(a):void a.call(null,b,c))})}function epg_getCurrencyPayment_v1(a){var b=epg_get_gateway_contract_v1();if(!b){console.log("Failed to obtain a gateway contract");return void("ETH"===jQuery("#epg-token").val()?a.call(null,window.epg.str_pay_eth_failure,null):a.call(null,window.epg.str_pay_token_failure,null))}b.getCurrencyPayment(window.epg.payment_address,window.epg.order_id,function(b,c){if(b)return console.log(b),void a.call(null,b,null);console.log(c),a.call(null,b,c)})}function epg_getCurrencyPayment(a){var b=epg_get_gateway_contract();if(!b){console.log("Failed to obtain a gateway contract");return void("ETH"===jQuery("#epg-token").val()?a.call(null,window.epg.str_pay_eth_failure,null):a.call(null,window.epg.str_pay_token_failure,null))}b.getCurrencyPayment(window.epg.payment_address,window.epg.order_id,function(b,c){return b?(console.log(b),void a.call(null,b,null)):(console.log(c),"0x0000000000000000000000000000000000000000"===c||"0x"===c?void epg_getCurrencyPayment_v1(a):void a.call(null,b,c))})}function epg_get_gateway_contract(){var a=JSON.parse(window.epg.gateway_abi);return window.epg.web3.eth.contract(a).at(window.epg.gateway_address)}function epg_get_gateway_contract_v1(){var a=JSON.parse(window.epg.gateway_abi_v1);return window.epg.web3.eth.contract(a).at(window.epg.gateway_address_v1)}function epg_payEth_getData(a){var b=window.epg.web3.toWei(parseFloat(window.epg.eth_value),"ether"),c=epg_get_gateway_contract();if(!c)return console.log("Failed to obtain a gateway contract"),void a.call(null,"Failed to obtain a gateway contract",null);var d=c.payEth.getData(window.epg.payment_address,window.epg.order_id,b);a.call(null,null,d)}function epg_get_erc20_contract(a){var b=JSON.parse(window.epg.erc20_abi);return window.epg.web3.eth.contract(b).at(a)}function epg_get_token_decimals(a,b){console.log("tokenAddress: ",a);var c=epg_get_erc20_contract(a);if(!c)return void b.call(null,"Failed to get contract",null);c.decimals(b)}function epg_get_token_balance_by_account(a,b,c){var d=epg_get_erc20_contract(a);if(!d)return void c.call(null,"Failed to get contract",null);d.balanceOf(b,c)}function epg_pay_ether(){if(void 0!==window.epg.web3metamask)return!(!jQuery("#epg-ether-alert").hasClass("hidden")&&!jQuery("#epg-ether-alert").is("[hidden]"))&&void epg_getValuePaymentEth(function(a,b){if(a)return console.log(a),void epg_alert(window.epg.str_pay_eth_failure);null===b||epg_round(b,5,"PHP_ROUND_HALF_UP")<parseFloat(window.epg.eth_value_with_dust)?epg_sendTransaction_impl(function(a,b){if(a)return console.log(a),a===window.epg.str_unlock_metamask_account?void epg_alert(window.epg.str_unlock_metamask_account):void epg_alert(window.epg.str_pay_eth_failure);epg_alert(window.epg.str_payment_complete),setTimeout(function(){location.reload()},1)}):epg_alert(window.epg.str_payment_complete)})}function epg_getTokenRate(a){var b=epg_getTokenInfoByAddress(a);return b?parseFloat(b.rate):null}function epg_payToken_getData(a,b){epg_get_token_decimals(a,function(c,d){if(c)return console.log(c),alert(window.epg.str_pay_token_failure),void b.call(null,c,null);if(null===d)return console.log("Failed to obtain ERC20 token decimals value"),void b.call(null,window.epg.str_pay_token_failure,null);var e=epg_get_gateway_contract();if(!e)return console.log("Failed to obtain a gateway contract"),void b.call(null,"Failed to obtain a gateway contract",null);var f=parseFloat(jQuery("#epg-amount").val()),g=f*Math.pow(10,d.toNumber());console.log("payToken params:",a,window.epg.payment_address,window.epg.order_id,g);var h=e.payToken.getData(a,window.epg.payment_address,window.epg.order_id,g);b.call(null,null,h)})}function epg_token_approve_getData(a,b,c){epg_get_token_decimals(a,function(d,e){if(d)return console.log(d),void c.call(null,d,null);if(null===e)return console.log("Failed to obtain ERC20 token decimals value"),void c.call(null,window.epg.str_pay_token_failure,null);var f=epg_get_erc20_contract(a);if(!f)return console.log("Failed to obtain a token contract"),void c.call(null,window.epg.str_pay_token_failure,null);var g=Math.ceil(b*Math.pow(10,e.toNumber()));if(void 0!==window.epg.web3metamask)epg_getUserAccounts(function(a,b){if(a)return console.log(a),void c.call(null,a,null);if(0===b.length){console.log("Metamask account not found");var d=f.approve.getData(window.epg.gateway_address,g);return void c.call(null,null,d)}var e=b[0];f.allowance(e,window.epg.gateway_address,function(a,b){if(0===(b=b.toNumber())){var d=f.approve.getData(window.epg.gateway_address,g);c.call(null,null,d)}else{var d=f.approve.getData(window.epg.gateway_address,0);c.call(null,null,d)}})});else{var h=f.approve.getData(window.epg.gateway_address,g);c.call(null,null,h)}})}function epg_token_check_deposit(a,b,c){epg_get_token_decimals(a,function(d,e){if(d)return console.log(d),void c.call(null,d,null);if(null===e)return console.log("Failed to obtain ERC20 token decimals value"),void c.call(null,window.epg.str_pay_token_failure,null);var f=epg_get_erc20_contract(a);if(!f)return console.log("Failed to obtain a token contract"),void c.call(null,window.epg.str_pay_token_failure,null);var g=Math.ceil(b*Math.pow(10,e.toNumber()));void 0!==window.epg.web3metamask?epg_getUserAccounts(function(a,b){if(a)return console.log(a),void c.call(null,a,null);if(0===b.length)return console.log("Metamask account not found"),void c.call(null,window.epg.str_unlock_metamask_account,null);var d=b[0];f.allowance(d,window.epg.gateway_address,function(a,b){b=b.toNumber(),c.call(null,null,b>=g)})}):c.call(null,null,null)})}function epg_copyAddress(a){a.preventDefault();var b=jQuery("<input>");jQuery("body").append(b);var c=jQuery(a.target).data("input-id");console.log("Copy from: ",c);var d=jQuery("#"+c).val();console.log("Value to copy: ",d),b.val(d).select(),document.execCommand("copy"),b.remove(),alert(window.epg.str_copied_msg)}function epg_openDownloadMetamaskWindow(a){a.preventDefault(),window.open("https://metamask.io/","_blank","location=yes,height="+window.outerHeight+",width="+window.outerWidth+",scrollbars=yes,status=yes").focus()}function epg_task_queue_get(){return void 0===window.epg.task_queue&&(window.epg.task_queue=[]),window.epg.task_queue}function epg_task_queue_push(a){console.log("task queue: push"),epg_task_queue_get().push(a)}function epg_task_queue_empty(){return 0===epg_task_queue_get().length}function epg_task_queue_top(){var a=epg_task_queue_get();return 0===a.length?null:a[0]}function epg_task_queue_pop(){console.log("task queue: pop");var a=epg_task_queue_get();return 0===a.length?null:a.shift()}function epg_task_queue_process_next_task(){console.log("task queue: process next");var a=epg_task_queue_top();a&&a.call(null,function(){epg_task_queue_pop(),epg_task_queue_process_next_task()})}function epg_initWizard(a){if(void 0===a&&(a=function(){}),jQuery("#rootwizard").removeClass("hidden"),jQuery("#rootwizard").removeAttr("hidden"),jQuery("#rootwizard-help-info").removeClass("hidden"),jQuery("#rootwizard-help-info").removeAttr("hidden"),void 0!==window.epg.is_wizard_initialised&&window.epg.is_wizard_initialised)return void a.call(null,null,null);window.epg.is_wizard_initialised=!0,jQuery("#rootwizard").bootstrapWizard({onTabShow:function(a,b,c){var d=b.find("li").length,e=c+1,f=e/d*100;switch(jQuery("#rootwizard .progress-bar").css({width:f+"%"}),console.log("tab: "+c),c){case EPG_STEP.deposit:var g=epg_task_queue_empty();epg_task_queue_push(function(a){epg_switch_to_step1(function(){void 0!==window.epg["epg-token-advanced-details-step1-opened"]||"undefined"!=typeof window&&void 0!==window.web3||(jQuery("#epg-token-advanced-details-step1-button").click(),jQuery("#epg-token-advanced-details-step1-button").parent().hide(),window.epg["epg-token-advanced-details-step1-opened"]=!0),change_epg_gateway_address(),change_epg_data_value(),jQuery("#epg-button-next").removeClass("disabled"),a.call(null)})}),g&&epg_task_queue_process_next_task();break;case EPG_STEP.payment:var g=epg_task_queue_empty();epg_task_queue_push(function(a){epg_switch_to_step2(function(){void 0!==window.epg["epg-token-advanced-details-step2-opened"]||"undefined"!=typeof window&&void 0!==window.web3||(jQuery("#epg-token-advanced-details-step2-button").click(),jQuery("#epg-token-advanced-details-step2-button").parent().hide(),window.epg["epg-token-advanced-details-step2-opened"]=!0),change_epg_gateway_address_step2(),change_epg_data_value_step2(),a.call(null)})}),g&&epg_task_queue_process_next_task()}},onTabClick:function(a,b,c){return!(void 0!==window.epg.web3metamask)},onPrevious:function(a,b,c){if(console.log("prev: "+c),!jQuery("#epg-alert").hasClass("hidden")&&!jQuery("#epg-alert").is("[hidden]"))return!1;void 0===window.epg.web3metamask&&jQuery("#epg-button-next").removeClass("disabled")},onNext:function(a,b,c){if(console.log("next: "+c),!jQuery("#epg-alert").hasClass("hidden")&&!jQuery("#epg-alert").is("[hidden]"))return!1;var d=jQuery("#epg-token").val();switch(c){case EPG_STEP.deposit:break;case EPG_STEP.payment:if(void 0!==window.epg.web3metamask)return epg_getValuePaymentEth(function(a,b){if(a)return console.log(a),void epg_alert("ETH"===d?window.epg.str_deposit_eth_failure:window.epg.str_deposit_token_failure);if(null===b||epg_round(b,5,"PHP_ROUND_HALF_UP")<epg_round(parseFloat(window.epg.eth_value),5,"PHP_ROUND_HALF_UP"))epg_sendTransaction_impl(function(a,b){if(a){if(console.log(a),a===window.epg.str_unlock_metamask_account){if(jQuery("#rootwizard").bootstrapWizard("show",EPG_STEP.payment),"ETH"!==d)var c=setTimeout(function(){clearTimeout(c),jQuery("#epg-button-next").removeClass("disabled")},1);return}return a===window.epg.str_pay_token_failure_insufficient_balance?void epg_alert(window.epg.str_deposit_token_failure_insufficient_balance):a===window.epg.str_pay_token_failure?void epg_alert(window.epg.str_deposit_token_failure):void epg_alert("ETH"===d?window.epg.str_deposit_eth_failure:window.epg.str_deposit_token_failure)}if(epg_alert("ETH"===d?window.epg.str_deposit_eth_success:window.epg.str_deposit_token_success),jQuery("#rootwizard").bootstrapWizard("show",EPG_STEP.payment),"ETH"!==d)var c=setTimeout(function(){clearTimeout(c),jQuery("#epg-button-next").removeClass("disabled")},1)});else if(jQuery("#rootwizard").bootstrapWizard("show",EPG_STEP.payment),"ETH"!==d)var c=setTimeout(function(){clearTimeout(c),jQuery("#epg-button-next").removeClass("disabled")},1)}),!1;jQuery("#epg-button-next").addClass("disabled");break;case EPG_STEP.result:if(void 0!==window.epg.web3metamask)return epg_getValuePaymentEth(function(a,b){if(a)return console.log(a),void epg_alert("ETH"===d?window.epg.str_pay_eth_failure:window.epg.str_pay_token_failure);(null===b||epg_round(b,5,"PHP_ROUND_HALF_UP")<parseFloat(window.epg.eth_value))&&epg_sendTransaction_eth_step2_impl()}),!1}},nextSelector:"#epg-button-next",previousSelector:"#epg-button-previous"}),a.call(null,null,null)}function change_epg_gateway_address(){jQuery(".epg-token-step1-canvas-qr2 > canvas").remove(),jQuery(".epg-token-step1-canvas-qr2").qrcode({text:jQuery("#epg-gateway-address").val()})}function change_epg_data_value(){jQuery(".epg-token-step1-canvas-qr3 > canvas").remove(),jQuery(".epg-token-step1-canvas-qr3").qrcode({text:jQuery("#epg-data-value").text()})}function change_epg_gateway_address_step2(){jQuery(".epg-token-step2-canvas-qr2 > canvas").remove(),jQuery(".epg-token-step2-canvas-qr2").qrcode({text:jQuery("#epg-gateway-address-step2").val()})}function change_epg_data_value_step2(){jQuery(".epg-token-step2-canvas-qr3 > canvas").remove(),jQuery(".epg-token-step2-canvas-qr3").qrcode({text:jQuery("#epg-data-value-step2").text()})}var EPG_STEP={deposit:0,payment:1,result:2};jQuery(document).ready(function(){if(jQuery('.epg-payment-instructions .navbar a[href*="#"], a.btn[href*="#"]').off("click"),void 0!==window.epg&&void 0!==window.epg.web3Endpoint){if("undefined"!=typeof window&&void 0!==window.web3){var a=window.web3.currentProvider;window.epg.web3metamask=new Web3(a),jQuery("#epg-ether-mm-pay").click(epg_pay_ether)}else jQuery("#epg-ether-mm-pay").addClass("hidden"),jQuery("#epg-ether-mm-pay").attr("hidden","hidden"),jQuery("#epg-ether-download-metamask-button").removeClass("hidden"),jQuery("#epg-ether-download-metamask-button").removeAttr("hidden"),jQuery("#epg-ether-download-metamask-button").click(epg_openDownloadMetamaskWindow),jQuery("#epg-download-metamask-button").removeClass("hidden"),jQuery("#epg-download-metamask-button").removeAttr("hidden"),jQuery("#epg-download-metamask-button").click(epg_openDownloadMetamaskWindow),jQuery("#epg-button-next").removeClass("offset-md-8");setInterval(function(){"undefined"!=typeof window&&void 0!==window.web3?epg_getUserAccounts(function(a,b){return a?void console.log(a):0===b.length?((jQuery("#epg-payment-success-message-wrapper").hasClass("hidden")||jQuery("#epg-payment-success-message-wrapper").is("[hidden]"))&&(jQuery("#epg-unlock-metamask-message-wrapper").removeClass("hidden"),jQuery("#epg-unlock-metamask-message-wrapper").removeAttr("hidden")),jQuery("#epg-button-previous").removeClass("hidden"),jQuery("#epg-button-previous").removeAttr("hidden"),void jQuery("#epg-wizard-buttons-group").removeClass("offset-md-2")):(jQuery("#epg-unlock-metamask-message-wrapper").addClass("hidden"),void jQuery("#epg-unlock-metamask-message-wrapper").attr("hidden","hidden"))}):((jQuery("#epg-payment-success-message-wrapper").hasClass("hidden")||jQuery("#epg-payment-success-message-wrapper").is("[hidden]"))&&(jQuery("#epg-unlock-metamask-message-wrapper").removeClass("hidden"),jQuery("#epg-unlock-metamask-message-wrapper").removeAttr("hidden")),jQuery("#epg-button-previous").removeClass("hidden"),jQuery("#epg-button-previous").removeAttr("hidden"),jQuery("#epg-wizard-buttons-group").removeClass("offset-md-2"))},3e3),void 0!==window.epg.web3Endpoint&&(window.epg.web3=new Web3(new Web3.providers.HttpProvider(window.epg.web3Endpoint))),window.epg.web3metamask&&window.epg.web3metamask.version.getNetwork(function(a,b){if(a)return void console.log(a);switch(b){case"1":window.epg.mm_network_mismatch=-1===window.epg.web3Endpoint.indexOf("mainnet");break;case"3":window.epg.mm_network_mismatch=-1===window.epg.web3Endpoint.indexOf("ropsten");break;case"4":window.epg.mm_network_mismatch=-1===window.epg.web3Endpoint.indexOf("rinkeby");break;case"42":window.epg.mm_network_mismatch=-1===window.epg.web3Endpoint.indexOf("kovan");break;default:console.log("This is an unknown network."),window.epg.mm_network_mismatch=!0}window.epg.mm_network_mismatch?(jQuery("#epg-metamask-network-mismatch-message-wrapper").removeClass("hidden"),jQuery("#epg-metamask-network-mismatch-message-wrapper").removeAttr("hidden")):(jQuery("#epg-metamask-network-mismatch-message-wrapper").addClass("hidden"),jQuery("#epg-metamask-network-mismatch-message-wrapper").attr("hidden","hidden"))}),epg_show_wait_icon(),epg_getValuePaymentEth(function(a,b){return a?(console.log(a),epg_alert(a),void epg_hide_wait_icon()):null===b||epg_round(b,5,"PHP_ROUND_HALF_UP")<parseFloat(window.epg.eth_value)?(epg_hide_wait_icon(),jQuery("#epg-payment-incomplete-message-wrapper").removeClass("hidden"),void jQuery("#epg-payment-incomplete-message-wrapper").removeAttr("hidden")):(jQuery("#epg-payment-success-message-wrapper").removeClass("hidden"),jQuery("#epg-payment-success-message-wrapper").removeAttr("hidden"),jQuery("#epg-ether-payment").addClass("hidden"),jQuery("#epg-ether-payment").attr("hidden","hidden"),jQuery("#rootwizard-help-info").addClass("hidden"),jQuery("#rootwizard-help-info").attr("hidden","hidden"),jQuery("#epg-unlock-metamask-message-wrapper").addClass("hidden"),jQuery("#epg-unlock-metamask-message-wrapper").attr("hidden","hidden"),jQuery("#epg-token-wrapper").addClass("hidden"),jQuery("#epg-token-wrapper").attr("hidden","hidden"),
void epg_hide_wait_icon())}),jQuery("#epg-token").change(epg_tokenChange),jQuery(".epg-copy-button").click(epg_copyAddress),epg_getCurrencyPayment(function(a,b){return a?(console.log(a),alert(a),void epg_fill_payment_info()):"0x0000000000000000000000000000000000000000"===b||"0x"===b?void epg_fill_payment_info():void 0})}window.addEventListener("beforeunload",function(a){if(!jQuery("#epg-ether-alert").hasClass("hidden")&&!jQuery("#epg-ether-alert").is("[hidden]")){var b=window.epg.str_page_unload_text;return(a||window.event).returnValue=b,b}}),jQuery(".epg-ether-canvas-qr1").qrcode({text:jQuery("#epg-ether-value").val()}),jQuery(".epg-ether-canvas-qr2").qrcode({text:jQuery("#epg-ether-gateway-address").val()}),jQuery(".epg-ether-canvas-qr3").qrcode({text:jQuery("#epg-ether-data-value").val()}),jQuery(".epg-token-step1-canvas-qr1").qrcode({text:jQuery("#epg-value").val()}),change_epg_gateway_address(),jQuery("#epg-gateway-address").change(change_epg_gateway_address),change_epg_data_value(),jQuery("#epg-data-value").change(change_epg_data_value),jQuery(".epg-token-step2-canvas-qr1").qrcode({text:jQuery("#epg-value-step2").val()}),change_epg_gateway_address_step2(),jQuery("#epg-gateway-address-step2").change(change_epg_gateway_address_step2),change_epg_data_value_step2(),jQuery("#epg-data-value-step2").change(change_epg_data_value_step2)});